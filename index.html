<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Perpustakaan Terpadu</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; line-height: 1.6; }
        .selector-section { margin-bottom: 30px; padding: 15px; background: #e9ecef; border-radius: 8px; }
        select { padding: 10px; width: 100%; font-size: 16px; border-radius: 5px; }
        .book-card { border: 2px solid #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .review-card { background: #f4f4f4; padding: 10px; margin: 10px 0; border-left: 5px solid #007bff; }
        .rating { color: #f39c12; font-weight: bold; }
        .tag { background: #ddd; padding: 2px 8px; border-radius: 5px; font-size: 0.8em; margin-right: 5px; }
        .loading { font-style: italic; color: #666; }
    </style>
</head>
<body>
    <h1> Layanan Katalog & Review Buku </h1>

    <div class="selector-section">
        <label for="bookSelect"><strong>Pilih Buku untuk Dilihat:</strong></label>
        <select id="bookSelect" onchange="loadBookDetails(this.value)">
            <option value="">-- Sila Tunggu, Memuatkan Senarai Buku... --</option>
        </select>
    </div>

    <div id="content">
        <p class="loading">Sila pilih buku dari senarai di atas untuk melihat butiran dan ulasan.</p>
    </div>

    <script>
        const API_KEY = "uas-sukses-tst";
        const BASE_CATALOG_URL = "https://darryl.tugastst.my.id/books";
        const BASE_REVIEW_URL = "https://farhan.tugastst.my.id/reviews/book"; 

        async function loadBookList() {
            try {
                const response = await fetch(BASE_CATALOG_URL, { 
                    headers: { 'uas-api-key': API_KEY } 
                });
                const result = await response.json();

                if (result.status === "success") {
                    const select = document.getElementById('bookSelect');
                    select.innerHTML = '<option value="">-- Pilih Buku --</option>';
                    
                    result.data.forEach(book => {
                        const option = document.createElement('option');
                        option.value = book.id;
                        option.textContent = book.title;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Gagal memuatkan senarai buku:", error);
                document.getElementById('bookSelect').innerHTML = '<option value="">Gagal memuatkan data</option>';
            }
        }

        async function loadBookDetails(bookId) {
            if (!bookId) {
                document.getElementById('content').innerHTML = '<p class="loading">Sila pilih buku dari senarai di atas.</p>';
                return;
            }

            document.getElementById('content').innerHTML = '<p class="loading">Sedang memproses data...</p>';

            try { 
                const resBook = await fetch(`${BASE_CATALOG_URL}/${bookId}`, { 
                    headers: { 'uas-api-key': API_KEY } 
                });
                const bookData = await resBook.json();

                const resReview = await fetch(`${BASE_REVIEW_URL}/${bookId}`, { 
                    headers: { 'uas-api-key': API_KEY } 
                });
                const reviewData = await resReview.json();

                if (bookData.status === "success") {
                    const book = bookData.data;
                    let html = `
                        <div class="book-card">
                            <h2>${book.title}</h2>
                            <p><strong>Penulis:</strong> ${book.author} (${book.published_year})</p>
                            <p><strong>Sinopsis:</strong> ${book.synopsis}</p>
                            <p><strong>Stok Tersedia:</strong> ${book.stock}</p>
                            <hr>
                            <h3>Ulasan Pembaca (Rating Purata: <span class="rating">${reviewData.average_rating.toFixed(1)}/5.0</span>)</h3>
                    `;

                    if (reviewData.reviews.length === 0) {
                        html += `<p><em>Belum ada ulasan untuk buku ini.</em></p>`;
                    } else {
                        reviewData.reviews.forEach(rev => {
                            html += `
                                <div class="review-card">
                                    <strong>${rev.reviewer}</strong> - <span class="rating">‚≠ê ${rev.rating}</span>
                                    <p>"${rev.comment}"</p>
                                    <div>${rev.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
                                </div>
                            `;
                        });
                    }

                    html += `</div>`;
                    document.getElementById('content').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('content').innerHTML = "Gagal memuat data. Sila pastikan STB dan Tunnel sedang aktif.";
            }
        }

        loadBookList();
    </script>
</body>
</html>